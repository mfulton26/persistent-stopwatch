<!DOCTYPE html>
<html lang="en">
  <head>
    <base target="_top" />
    <title>Persistable Stopwatch</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <style>
      html,
      body {
        height: 100%;
      }

      html {
        display: table;
        margin: auto;
      }

      body {
        display: table-cell;
        vertical-align: middle;
        text-align: center;
      }

      #duration {
        font-family: "Courier New", Courier, monospace;
        font-weight: bold;
        font-size: 10vmax;
      }

      .material-icons {
        font-size: 7vmax;
      }
    </style>
  </head>
  <body>
    <div>
      <output id="duration"></output>
    </div>
    <div>
      <button id="startOrStop" class="material-icons" autofocus></button>
      <button id="reset" class="material-icons" title="Reset">refresh</button>
    </div>
    <script>
      const durationOutput = document.getElementById("duration");
      const startOrStopButton = document.getElementById("startOrStop");
      const resetButton = document.getElementById("reset");

      let origin;
      let offset;

      function load(location) {
        const params = new URLSearchParams(location.search);
        origin = params.has("origin")
          ? Number(params.get("origin"))
          : undefined;
        offset = params.has("offset")
          ? Number(params.get("offset"))
          : undefined;
        render();
      }

      function render() {
        const duration = millisecondsToDurationString(offset || 0);
        durationOutput.innerText = duration;
        if (origin === undefined) {
          document.title = `${duration} | Persistable Stopwatch`;
          startOrStopButton.title = "Start";
          startOrStopButton.innerText = "play_arrow";
          resetButton.disabled = offset === undefined;
        } else {
          document.title = "Running | Persistable Stopwatch";
          startOrStopButton.title = "Stop";
          startOrStopButton.innerText = "stop";
          resetButton.disabled = false;
          animate();
        }
      }

      function animate() {
        if (origin === undefined) {
          return;
        }
        const duration = millisecondsToDurationString(Date.now() - origin);
        durationOutput.innerText = duration;
        requestAnimationFrame(animate);
      }

      function millisecondsToDurationString(milliseconds) {
        const totalHours = Math.floor(milliseconds / 3600000);
        const minutesSecondsMilliseconds = new Date(milliseconds)
          .toISOString()
          .substr(14, 9);
        return `${totalHours}:${minutesSecondsMilliseconds}`;
      }

      startOrStopButton.addEventListener(
        "click",
        function pushStartOrStopHistoryState() {
          if (origin === undefined) {
            origin = Date.now() - (offset || 0);
            offset = undefined;
            history.pushState(
              { offset },
              "Stopped",
              `${location.pathname}?origin=${origin}`
            );
          } else {
            offset = Date.now() - origin;
            origin = undefined;
            history.pushState(
              { offset },
              "Running",
              `${location.pathname}?offset=${offset}`
            );
          }
        }
      );
      startOrStopButton.addEventListener("click", render);

      resetButton.addEventListener(
        "click",
        function pushUnstartedHistoryState() {
          origin = undefined;
          offset = undefined;
          history.pushState({ offset }, "Unstarted", location.pathname);
        }
      );
      resetButton.addEventListener("click", render);

      load(location);

      onpopstate = function(event) {
        load(location);
      };
    </script>
  </body>
</html>
