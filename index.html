<!DOCTYPE html>
<html lang="en">
  <head>
    <base target="_top" />
    <title>Persistable Stopwatch</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <style>
      html,
      body {
        height: 100%;
      }

      html {
        display: table;
        margin: auto;
      }

      body {
        display: table-cell;
        vertical-align: middle;
        text-align: center;
      }

      #duration {
        font-family: "Courier New", Courier, monospace;
        font-weight: bold;
        font-size: 10vmax;
      }

      .material-icons {
        font-size: 7vmax;
      }
    </style>
  </head>
  <body>
    <div>
      <output id="duration"></output>
    </div>
    <div>
      <button id="startOrStop" class="material-icons" autofocus></button>
      <button id="reset" class="material-icons" title="Reset">refresh</button>
    </div>
    <script>
      var durationHTMLOutputElement = document.getElementById("duration");
      var startOrStopHTMLButtonElement = document.getElementById("startOrStop");
      var resetHTMLButtonElement = document.getElementById("reset");

      var origin;
      var offset;

      function load(location) {
        var params = new URLSearchParams(location.search);
        origin = params.has("origin")
          ? Number(params.get("origin"))
          : undefined;
        offset = params.has("offset")
          ? Number(params.get("offset"))
          : undefined;
        render();
      }

      function render() {
        function millisecondsToDurationString(milliseconds) {
          return (
            Math.floor(milliseconds / 3600000) +
            ":" +
            new Date(milliseconds).toISOString().substr(14, 9)
          );
        }
        var duration = millisecondsToDurationString(offset || 0);
        durationHTMLOutputElement.innerText = millisecondsToDurationString(
          offset || 0
        );
        if (origin === undefined) {
          if (offset === undefined) {
            document.title = "Persistable Stopwatch";
            resetHTMLButtonElement.disabled = true;
            startOrStopHTMLButtonElement.title = "Start";
          } else {
            document.title = duration + " | Persistable Stopwatch";
            resetHTMLButtonElement.disabled = false;
            startOrStopHTMLButtonElement.title = "Resume";
          }
          startOrStopHTMLButtonElement.innerText = "play_arrow";
        } else {
          document.title = "Running | Persistable Stopwatch";
          resetHTMLButtonElement.disabled = false;
          startOrStopHTMLButtonElement.title = "Stop";
          startOrStopHTMLButtonElement.innerText = "stop";
          (function update() {
            if (origin === undefined) {
              return;
            }
            durationHTMLOutputElement.innerText = millisecondsToDurationString(
              Date.now() - origin
            );
            requestAnimationFrame(update);
          })();
        }
      }

      load(location);

      onpopstate = function(event) {
        load(location);
      };

      startOrStopHTMLButtonElement.addEventListener("click", function() {
        if (origin === undefined) {
          origin = Date.now() - (offset || 0);
          offset = undefined;
          history.pushState(
            { offset },
            "Stopped",
            location.pathname + "?origin=" + origin
          );
        } else {
          offset = Date.now() - origin;
          origin = undefined;
          history.pushState(
            { offset },
            "Running",
            location.pathname + "?offset=" + offset
          );
        }
        render();
      });

      resetHTMLButtonElement.addEventListener("click", function() {
        origin = undefined;
        offset = undefined;
        history.pushState({ offset }, "Ready", location.pathname);
        render();
      });
    </script>
  </body>
</html>
